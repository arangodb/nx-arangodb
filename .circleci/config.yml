version: 2.1

executors:
  python-executor:
    docker:
      - image: circleci/python:3.10
    environment:
      PACKAGE_DIR: nx_arangodb
      TESTS_DIR: tests

  machine-executor:
    machine:
      image: ubuntu-2404:2024.05.1

jobs:
  lint:
    executor: python-executor
    steps:
      - checkout

      - run:
          name: Setup pip
          command: python -m pip install --upgrade pip setuptools wheel

      - run:
          name: Install packages
          command: pip install .[dev]

      - run:
          name: Run black
          command: black --check --verbose --diff --color $PACKAGE_DIR $TESTS_DIR

      - run:
          name: Run flake8
          command: flake8 $PACKAGE_DIR $TESTS_DIR

      - run:
          name: Run isort
          command: isort --check --profile=black $PACKAGE_DIR $TESTS_DIR

      - run:
          name: Run mypy
          command: mypy $PACKAGE_DIR $TESTS_DIR

  test:
    executor: machine-executor
    steps:
      - checkout

      - run:
          name: Set up ArangoDB
          command: |
            chmod +x starter.sh
            ./starter.sh

      - run:
          name: Install Dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git

      - run:
          name: Remove existing pyenv if exists
          command: |
            if [ -d "/opt/circleci/.pyenv" ]; then
              sudo rm -rf /opt/circleci/.pyenv
            fi  

      - run:
          name: Install pyenv
          command: |
            curl https://pyenv.run | bash
            echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bashrc
            echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
            echo 'eval "$(pyenv init -)"' >> ~/.bashrc
            echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
            source ~/.bashrc

      - run:
          name: Install Python 3.10
          command: |
            pyenv install 3.10.6
            pyenv global 3.10.6

      - run:
          name: Setup pip
          command: python -m pip install --upgrade pip setuptools wheel

      - run:
          name: Install packages
          command: pip install .[dev]

      - run:
          name: Install Phenolrs (temporary solution)
          command: pip install phenolrs --find-links .
          #command: pip install ./phenolrs-0.4.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl

      - run:
          name: Run local tests
          command: pytest tests/test.py

      - run:
          name: Run NetworkX tests
          command: ./run_nx_tests.sh

workflows:
  version: 2
  build:
    jobs:
      - lint
      - test:
          requires:
            - lint